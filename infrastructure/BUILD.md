# Lambda Layers Build Process

This document explains the new Lambda layers architecture and build process for the PDF Extractor API.

## Architecture Overview

### Lambda Layers Structure

1. **Common Dependencies Layer** (`pdf-extractor-common`)
   - AWS SDK (boto3, botocore)
   - PDF processing (pdfplumber, pandas)
   - Authentication (pydantic, PyJWT)
   - Utilities (python-magic, aws-lambda-powertools)
   - Size: ~100MB

2. **API Dependencies Layer** (`pdf-extractor-api`)
   - FastAPI framework
   - ASGI server (uvicorn)
   - Lambda adapter (mangum)
   - HTTP client (httpx)
   - Size: ~50MB

3. **Business Logic Layer** (`pdf-extractor-business`)
   - Application code modules
   - Configuration and utilities
   - Size: ~5MB

### Lambda Functions

Each Lambda function is now lightweight (~1MB) and contains only:
- `handler.py` - Function entry point
- Function-specific logic

## Build Scripts

### Quick Build (Recommended)

Build everything with one command:
```bash
./scripts/build-all.sh
```

### Individual Scripts

Build only layers:
```bash
./scripts/build-layers.sh
```

Build only functions:
```bash
./scripts/build-functions.sh
```

## Directory Structure

```
infrastructure/
├── layers/
│   ├── common-dependencies/
│   │   └── requirements.txt
│   ├── api-dependencies/
│   │   └── requirements.txt
│   └── business-logic/
├── lambda_packages/          # Generated by build scripts
│   ├── layers/
│   │   ├── pdf-extractor-common.zip
│   │   ├── pdf-extractor-api.zip
│   │   └── pdf-extractor-business.zip
│   └── functions/
│       ├── api.zip
│       ├── processor.zip
│       ├── cleanup.zip
│       └── dlq_processor.zip
└── scripts/
    ├── build-all.sh          # Master build script
    ├── build-layers.sh       # Layer build script
    └── build-functions.sh    # Function build script
```

## Benefits of This Approach

### Storage Efficiency
- **Before**: 4 × ~200MB = 800MB total
- **After**: 155MB layers + 4MB functions = 159MB total
- **Savings**: 80% reduction

### Deployment Speed
- Layers cached by AWS Lambda
- Only redeploy small function code changes
- Faster CI/CD pipelines

### Version Management
- Pin layer versions for stability
- Update dependencies independently
- Easy rollbacks

## Build Process Details

### Layer Build Process

1. **Common Dependencies**:
   - Creates Python 3.11 site-packages structure
   - Installs common dependencies
   - Optimizes by removing __pycache__, tests, etc.
   - Creates zip with proper Lambda layer structure

2. **API Dependencies**:
   - Same process as common, but for API-specific packages
   - Only attached to API Lambda function

3. **Business Logic**:
   - Copies Python modules from ../api/
   - Creates proper Python package structure
   - Much smaller since it's just source code

### Function Build Process

1. Copies `handler.py` from each Lambda directory
2. Creates minimal zip packages
3. Functions rely on layers for dependencies

## Prerequisites

- Python 3.11
- pip
- zip command
- bash

## Troubleshooting

### Common Issues

1. **Permission denied**: Run `chmod +x scripts/*.sh`
2. **Python not found**: Ensure Python 3.11 is installed
3. **Import errors**: Check that business logic layer includes all required modules

### Debugging

1. Check build logs for specific errors
2. Verify directory structure matches expected layout
3. Ensure all required modules are in the business logic layer

## Next Steps

After running the build scripts:

1. Update Terraform configuration to use layers
2. Deploy with `terraform apply`
3. Test Lambda functions with layers attached

## Performance Impact

### Cold Start Improvements
- Smaller function packages = faster downloads
- Cached layers reduce initialization time
- Overall cold start reduction: ~30-50%

### Cost Savings
- Reduced storage costs
- Faster deployments reduce build time costs
- Shared layers across multiple functions